name: "Backup CosmosDB to Azure Storage"
description: "Backs up a CosmosDB instance to a Storage Account using Azure CLI"
inputs:
  AZURE_CREDENTIALS:
    description: 'Azure credentials in JSON format'
    required: true
  ARM_CLIENT_ID:
    description: 'Azure Client ID'
    required: true
  ARM_CLIENT_SECRET:
    description: 'Azure Client Secret'
    required: true
  ARM_SUBSCRIPTION_ID:
    description: 'Azure Subscription ID'
    required: true
  ARM_TENANT_ID:
    description: 'Azure Tenant ID'
    required: true
  COSMOS_ENDPOINT:
    description: 'Endpoint of the CosmosDB account'
    required: true
  COSMOS_KEY:
    description: 'Access key for CosmosDB'
    required: true
  CONTAINER_NAME:
    description: 'Name of the container in CosmosDB'
    required: true
  DATABASE_NAME:
    description: 'Name of the database in CosmosDB'
    required: true
  RESOURCE_GROUP:
    description: 'Resource group of the CosmosDB'
    required: true
  STORAGE_ACCOUNT_NAME:
    description: 'Name of the Storage Account'
    required: true
  STORAGE_CONTAINER:
    description: 'Name of the container in the Storage Account'
    required: true
  SUBSCRIPTION_ID:
    description: 'Azure Subscription ID (duplicate for compatibility)'
    required: true
  action:
    description: 'Action to perform: backup or restore'
    required: true
    default: 'backup'
    options:
      - backup
      - restore

runs:
  using: "composite"
  steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install -r ${{ github.action_path }}/requirements.txt
      shell: bash

    - uses: azure/login@v2
      with:
        creds: ${{ inputs.AZURE_CREDENTIALS }}
        

    - name: Azure CLI script
      uses: azure/cli@v2
      with:
        azcliversion: latest
        inlineScript: |
          az account show

    - name: Upload Files
      uses: azure/cli@v2
      with:
        azcliversion: latest
        inlineScript: |
          az account show
          # CosmosDB environment variables
          export COSMOS_KEY="${{ inputs.COSMOS_KEY }}"
          export COSMOS_ENDPOINT="${{ inputs.COSMOS_ENDPOINT }}"
          export CONTAINER_NAME="${{ inputs.CONTAINER_NAME }}"
          export DATABASE_NAME="${{ inputs.DATABASE_NAME }}"
          export RESOURCE_GROUP="${{ inputs.RESOURCE_GROUP }}"
  
          # Storage Account environment variables
          export STORAGE_ACCOUNT_NAME="${{ inputs.STORAGE_ACCOUNT_NAME }}"
          export STORAGE_CONTAINER="${{ inputs.STORAGE_CONTAINER }}"
  
          # Azure Login environment variables
          export ARM_SUBSCRIPTION_ID="${{ inputs.ARM_SUBSCRIPTION_ID }}"
          export ARM_TENANT_ID="${{ inputs.ARM_TENANT_ID }}"
          export ARM_CLIENT_SECRET="${{ inputs.ARM_CLIENT_SECRET }}"
          export SUBSCRIPTION_ID="${{ inputs.SUBSCRIPTION_ID }}"
          export ARM_CLIENT_ID="${{ inputs.ARM_CLIENT_ID }}"
          EXPORT STORAGE_ACCOUNT_KEY=$(az storage account keys list --account-name ${{ inputs.STORAGE_ACCOUNT_NAME }} --query '[0].value' -o tsv)
          echo "Iniciando Job de backup"
          python ${{ github.action_path }}/"${{ inputs.action }}".py 
  
    - name: Install azcopy
      run: |
      sudo apt-get update
      sudo apt-get install -y wget
  
      # when ubuntu-latest changes this needs updating from 22.04
      wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb
      sudo dpkg -i packages-microsoft-prod.deb
      sudo apt-get update
      sudo apt-get install -y azcopy
      rm -f packages-microsoft-prod.deb
  
    - name: Copy file to Azure Blob Storage
      env:
      AZURE_STORAGE_ACCOUNT: ${{ inputs.STORAGE_ACCOUNT_NAME }}
      AZURE_CONTAINER_NAME: ${{ inputs.STORAGE_CONTAINER }}
      AZCOPY_AUTO_LOGIN_TYPE: AZCLI
      AZCOPY_TENANT_ID: ${{ inputs.ARM_TENANT_ID }}
      run: |
      azcopy sync --compare-hash=md5 \
        --delete-destination=true \
        --include-pattern="*.json" \
        "." "https://${AZURE_STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_CONTAINER_NAME}/"